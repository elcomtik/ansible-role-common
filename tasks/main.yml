---
# tasks file for common

- name: Remove cloud-init
  import_tasks: remove_cloudinit.yml
  tags: cloudinit

- name: Remove default non-priviledged user
  import_tasks: default_user_cleanup.yml
  when: remove_default_user | bool
  tags: default_user_cleanup

- name: Update whole system
  import_tasks: update_system.yml
  when: update_system | bool
  tags: update

- name: Configure Canonical livepatch for Ubuntu systems
  import_role:
    name: tsukune_ch.canonical_livepatch
  vars:
    ansible_become: True
  when:
    - ansible_distribution == "Ubuntu"
    - canonical_livepatch_enabled | bool
  tags: livepatching

- name: Install common packages
  import_tasks: common_pkgs.yml
  tags: common_pkgs

- name: Setup unlimited bash history for root
  import_tasks: unlimited_bash_history.yml
  tags: unlimited_bash_history

#- name: Apply security settings
#  import_tasks: security.yml
#  tags: security

- name: Configure DNS resolvers in /etc/resolv.conf
  import_role:
    name: jdauphant.dns
  vars:
    ansible_become: True
    dns_forced_in_dhclientconf: False
  when: configure_dns_resolvers | bool
  tags: resolvers

- name: Install & configure rsyslog
  import_role:
    name: robertdebock.rsyslog
  tags: syslogs

- name: Install & configure firewalld
  import_role:
    name: elcomtik.firewalld
  when: firewall_enabled
  tags: firewall

- name: Install & configure fail2ban
  import_role:
    name: robertdebock.fail2ban
  when:
    - firewall_enabled
    - fail2ban_enabled
  tags: fail2ban

- name: Install private CA to trust store
  import_role:
    name: bdellegrazie.ca-certificates 
  when: install_cacerts | bool
  tags: cacerts

- name: Configure user authentication
  import_role:
    name: hellofresh.sssd-ldap
  when: configure_user_auth | bool
  tags: user_auth

- name: Install & configure etckeeper
  import_role:
    name: elcomtik.etckeeper
  tags: etckeeper

- name: Install & configure prometheus node-exporter
  import_role:
    name: cloudalchemy.node-exporter
  tags:
   - monitoring
   - exporters:node
